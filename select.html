<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€‰æ‹©æ•°å­—äººå½¢è±¡</title>
    <style>
        /* ä¸ index.html å®Œå…¨ä¸€è‡´çš„æ¸å˜èƒŒæ™¯ */
        body{
            margin:0;
            padding:0;
            min-height:100vh;
            background:linear-gradient(135deg,#a8edea 0%,#fed6e3 100%);
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
        }
        .wrapper{
            text-align:center;
            background:rgba(255,255,255,.95);
            padding:40px 50px;
            border-radius:20px;
            box-shadow:0 8px 25px rgba(0,0,0,.1);
            max-width:1200px;
            margin:20px auto;
        }
        .wrapper h1{
            margin-bottom:30px;
            color:#4a90e2;
        }

        .section-title {
            font-size: 22px;
            color: #4a90e2;
            margin: 30px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            text-align: left;
        }

        .avatars{
            display:flex;
            gap:30px;
            justify-content:center;
            flex-wrap:wrap;
            margin-bottom: 30px;
        }
        .avatar-card{
            cursor:pointer;
            transition:transform .3s;
            width: 180px;
        }
        .avatar-card:hover{
            transform:translateY(-8px);
        }
        .avatar-card img{
            width:160px;
            height:160px;
            object-fit:contain;
            border-radius:15px;
            background:#fff;
            padding:10px;
            box-shadow:0 4px 15px rgba(0,0,0,.1);
        }
        .avatar-card p{
            margin-top:10px;
            color:#555;
            font-size: 14px;
        }

        /* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .upload-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
        }

        .upload-area {
            border: 3px dashed #4a90e2;
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(74, 144, 226, 0.05);
        }

        .upload-area:hover {
            background: rgba(74, 144, 226, 0.1);
            border-color: #3a80d2;
        }

        .upload-area.dragover {
            background: rgba(74, 144, 226, 0.2);
            border-color: #2a70c2;
        }

        .upload-icon {
            font-size: 48px;
            color: #4a90e2;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #666;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 14px;
        }

        .upload-btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .upload-btn:hover {
            background: #3a80d2;
            transform: translateY(-2px);
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .file-input {
            display: none;
        }

        .preview-container {
            margin-top: 20px;
            text-align: center;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,.2);
            margin-bottom: 15px;
        }

        .uploaded-avatars {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .uploaded-card {
            width: 150px;
        }

        .uploaded-card img {
            width: 140px;
            height: 140px;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 14px;
        }

        .status-success {
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
            border: 1px solid #2ecc71;
        }

        .status-error {
            background: rgba(231, 76, 60, 0.2);
            color: #c0392b;
            border: 1px solid #e74c3c;
        }

        .status-loading {
            background: rgba(52, 152, 219, 0.2);
            color: #2980b9;
            border: 1px solid #3498db;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .action-buttons {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .back-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }

        .continue-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .continue-btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .continue-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .wrapper {
                padding: 20px;
                margin: 10px;
            }

            .avatars {
                gap: 15px;
            }

            .avatar-card, .uploaded-card {
                width: 140px;
            }

            .avatar-card img, .uploaded-card img {
                width: 120px;
                height: 120px;
            }
        }
    </style>
</head>
<body>
<div class="wrapper">
    <h1>é€‰æ‹©æ•°å­—äººå½¢è±¡</h1>

    <!-- é¢„ç½®å½¢è±¡ -->
    <div class="section-title">ğŸ¨ é¢„ç½®æ•°å­—äººå½¢è±¡</div>
    <div class="avatars" id="preset-avatars">
        <!-- é¢„ç½®å½¢è±¡ä¼šé€šè¿‡JSåŠ¨æ€åŠ è½½ -->
    </div>

    <!-- å·²ä¸Šä¼ çš„å½¢è±¡ -->
    <div class="section-title" id="uploaded-title" style="display:none;">ğŸ“ æ‚¨ä¸Šä¼ çš„å½¢è±¡</div>
    <div class="avatars uploaded-avatars" id="uploaded-avatars">
        <!-- å·²ä¸Šä¼ çš„å½¢è±¡ä¼šé€šè¿‡JSåŠ¨æ€åŠ è½½ -->
    </div>

    <!-- ä¸Šä¼ æ–°å½¢è±¡ -->
    <div class="section-title">ğŸ“¤ ä¸Šä¼ è‡ªå®šä¹‰å½¢è±¡</div>
    <div class="upload-section">
        <div class="upload-area" id="drop-area">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </div>
            <div class="upload-hint">æ”¯æŒ PNGã€JPGã€JPEGã€GIFã€BMPã€WEBP æ ¼å¼</div>
            <input type="file" id="file-input" class="file-input" accept=".png,.jpg,.jpeg,.gif,.bmp,.webp">
            <button class="upload-btn" id="browse-btn">
                <span>é€‰æ‹©å›¾ç‰‡</span>
            </button>
        </div>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div class="preview-container" id="preview-container" style="display:none;">
            <img id="preview-image" class="preview-image" src="" alt="é¢„è§ˆ">
            <div id="upload-status" class="status-message"></div>
            <button class="upload-btn" id="confirm-upload-btn" style="display:none;">
                <span>ç¡®è®¤ä¸Šä¼ </span>
            </button>
        </div>

        <!-- çŠ¶æ€æ¶ˆæ¯ -->
        <div id="status-message" class="status-message" style="display:none;"></div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="action-buttons">
        <a href="/" class="back-btn">è¿”å›é¦–é¡µ</a>
        <button class="continue-btn" id="continue-btn" disabled>ç»§ç»­ä½¿ç”¨å½“å‰å½¢è±¡</button>
    </div>

    <!-- å½“å‰é€‰æ‹©æ˜¾ç¤º -->
    <div id="current-selection" style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 10px; display: none;">
        <h3 style="color: #4a90e2; margin-bottom: 10px;">å½“å‰é€‰æ‹©çš„å½¢è±¡</h3>
        <div id="selected-avatar-info"></div>
    </div>
</div>

<script>
    // å…¨å±€å˜é‡
    let selectedAvatarId = null;
    let selectedAvatarType = null; // 'preset' æˆ– 'uploaded'
    let selectedAvatarName = null;
    let selectedAvatarUrl = null;
    let uploadedAvatars = [];
    let currentFile = null;
    let isUploading = false;

    const API_BASE_URL = 'http://localhost:5000/api';

    // DOM å…ƒç´ 
    const presetAvatarsContainer = document.getElementById('preset-avatars');
    const uploadedAvatarsContainer = document.getElementById('uploaded-avatars');
    const uploadedTitle = document.getElementById('uploaded-title');
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const browseBtn = document.getElementById('browse-btn');
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('preview-image');
    const uploadStatus = document.getElementById('upload-status');
    const confirmUploadBtn = document.getElementById('confirm-upload-btn');
    const statusMessage = document.getElementById('status-message');
    const continueBtn = document.getElementById('continue-btn');
    const currentSelection = document.getElementById('current-selection');
    const selectedAvatarInfo = document.getElementById('selected-avatar-info');

    // æ£€æŸ¥æ˜¯å¦æœ‰å·²é€‰æ‹©çš„å½¢è±¡
    function checkExistingSelection() {
        const savedAvatarId = localStorage.getItem('selectedAvatar');
        const savedAvatarType = localStorage.getItem('selectedAvatarType');
        const savedAvatarName = localStorage.getItem('selectedAvatarName');
        const savedAvatarUrl = localStorage.getItem('selectedAvatarUrl');

        if (savedAvatarId && savedAvatarType && savedAvatarName && savedAvatarUrl) {
            selectedAvatarId = savedAvatarId;
            selectedAvatarType = savedAvatarType;
            selectedAvatarName = savedAvatarName;
            selectedAvatarUrl = savedAvatarUrl;

            updateSelectionDisplay();
            enableContinueButton();
        }
    }

    // æ›´æ–°é€‰æ‹©æ˜¾ç¤º
    function updateSelectionDisplay() {
        if (selectedAvatarId && selectedAvatarName && selectedAvatarUrl) {
            selectedAvatarInfo.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="${selectedAvatarUrl}" alt="${selectedAvatarName}"
                         style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px;">
                    <div>
                        <h4 style="margin: 0 0 5px 0; color: #333;">${selectedAvatarName}</h4>
                        <p style="margin: 0; color: #666; font-size: 14px;">ID: ${selectedAvatarId}</p>
                    </div>
                </div>
            `;
            currentSelection.style.display = 'block';
        }
    }

    // å¯ç”¨ç»§ç»­æŒ‰é’®
    function enableContinueButton() {
        continueBtn.disabled = false;
        continueBtn.textContent = `ä½¿ç”¨ ${selectedAvatarName}`;
    }

    // ç¦ç”¨ç»§ç»­æŒ‰é’®
    function disableContinueButton() {
        continueBtn.disabled = true;
        continueBtn.textContent = 'ç»§ç»­ä½¿ç”¨å½“å‰å½¢è±¡';
    }

    // åŠ è½½é¢„ç½®å½¢è±¡
    function loadPresetAvatars() {
        const presetAvatars = [
            { id: '1', name: 'æ™ºèƒ½åŠ©æ‰‹', image: '/avatars/avatar1.png' },
            { id: '2', name: 'å¿ƒç†å’¨è¯¢å¸ˆ', image: '/avatars/avatar2.png' },
            { id: '3', name: 'å¿ƒçµå¯¼å¸ˆ', image: '/avatars/avatar3.png' }
        ];

        presetAvatars.forEach(avatar => {
            const card = document.createElement('div');
            card.className = 'avatar-card';
            card.dataset.id = avatar.id;
            card.dataset.type = 'preset';

            card.innerHTML = `
                <img src="${avatar.image}" alt="${avatar.name}" onerror="this.src='/avatars/avatar1.png'">
                <p>${avatar.name}</p>
            `;

            card.addEventListener('click', () => {
                selectAvatar(avatar.id, 'preset', avatar.name, avatar.image);
            });

            presetAvatarsContainer.appendChild(card);
        });
    }

    // åŠ è½½å·²ä¸Šä¼ çš„å½¢è±¡
    function loadUploadedAvatars() {
        fetch(`${API_BASE_URL}/get_avatars`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadedAvatars = data.avatars.filter(avatar => avatar.type === 'uploaded');

                    if (uploadedAvatars.length > 0) {
                        uploadedTitle.style.display = 'block';
                        uploadedAvatarsContainer.innerHTML = '';

                        uploadedAvatars.forEach(avatar => {
                            const card = document.createElement('div');
                            card.className = 'avatar-card uploaded-card';
                            card.dataset.id = avatar.id;
                            card.dataset.type = 'uploaded';

                            card.innerHTML = `
                                <img src="${avatar.image_url}" alt="${avatar.name}"
                                     onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'width:140px;height:140px;display:flex;align-items:center;justify-content:center;background:#f5f5f5;border-radius:15px;\\'><span style=\\'color:#999;\\'>å›¾ç‰‡åŠ è½½å¤±è´¥</span></div>'">
                                <p>${avatar.name}</p>
                            `;

                            card.addEventListener('click', () => {
                                selectAvatar(avatar.id, 'uploaded', avatar.name, avatar.image_url);
                            });

                            uploadedAvatarsContainer.appendChild(card);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('åŠ è½½å·²ä¸Šä¼ å½¢è±¡å¤±è´¥:', error);
            });
    }

    // é€‰æ‹©å½¢è±¡
    function selectAvatar(id, type, name, imageUrl) {
        // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©æ ·å¼
        document.querySelectorAll('.avatar-card').forEach(card => {
            card.style.boxShadow = '0 4px 15px rgba(0,0,0,.1)';
            card.style.border = 'none';
        });

        // æ·»åŠ å½“å‰é€‰æ‹©æ ·å¼
        const selectedCard = document.querySelector(`.avatar-card[data-id="${id}"]`);
        if (selectedCard) {
            selectedCard.style.boxShadow = '0 8px 25px rgba(74, 144, 226, 0.5)';
            selectedCard.style.border = '3px solid #4a90e2';
        }

        // æ›´æ–°é€‰æ‹©
        selectedAvatarId = id;
        selectedAvatarType = type;
        selectedAvatarName = name;
        selectedAvatarUrl = imageUrl;

        // æ›´æ–°æ˜¾ç¤º
        updateSelectionDisplay();
        enableContinueButton();

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä¸´æ—¶ï¼‰
        localStorage.setItem('tempSelectedAvatar', id);
        localStorage.setItem('tempSelectedAvatarType', type);
        localStorage.setItem('tempSelectedAvatarName', name);
        localStorage.setItem('tempSelectedAvatarUrl', imageUrl);

        showStatusMessage(`å·²é€‰æ‹©: ${name}`, 'success');
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatusMessage(message, type = 'info') {
        statusMessage.textContent = message;
        statusMessage.className = `status-message status-${type}`;
        statusMessage.style.display = 'block';

        // 3ç§’åè‡ªåŠ¨éšè—
        if (type !== 'loading') {
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }
    }

    // ä¸Šä¼ å›¾ç‰‡
    function uploadImage(file) {
        if (isUploading) return;

        isUploading = true;
        showStatusMessage('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 'loading');

        const formData = new FormData();
        formData.append('avatar', file);

        fetch(`${API_BASE_URL}/upload_avatar`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            isUploading = false;

            if (data.success) {
                showStatusMessage('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼', 'success');

                // æ¸…ç©ºé¢„è§ˆ
                previewContainer.style.display = 'none';
                previewImage.src = '';
                uploadStatus.textContent = '';
                confirmUploadBtn.style.display = 'none';
                currentFile = null;

                // é‡æ–°åŠ è½½å·²ä¸Šä¼ çš„å½¢è±¡
                loadUploadedAvatars();

                // è‡ªåŠ¨é€‰æ‹©æ–°ä¸Šä¼ çš„å½¢è±¡
                setTimeout(() => {
                    selectAvatar(data.avatar_id, 'uploaded', `æˆ‘çš„å½¢è±¡: ${data.filename.substring(0, 15)}...`, data.image_url);
                }, 500);
            } else {
                showStatusMessage(`ä¸Šä¼ å¤±è´¥: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            isUploading = false;
            console.error('ä¸Šä¼ é”™è¯¯:', error);
            showStatusMessage('ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        });
    }

    // é¢„è§ˆå›¾ç‰‡
    function previewImageFile(file) {
        if (!file.type.match('image.*')) {
            showStatusMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
            return;
        }

        if (file.size > 10 * 1024 * 1024) { // 10MBé™åˆ¶
            showStatusMessage('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB', 'error');
            return;
        }

        currentFile = file;

        const reader = new FileReader();
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            previewContainer.style.display = 'block';
            uploadStatus.textContent = `æ–‡ä»¶: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            uploadStatus.className = 'status-message status-info';
            confirmUploadBtn.style.display = 'inline-flex';
        };
        reader.readAsDataURL(file);
    }

    // ç»§ç»­åˆ°ä¸»é¡µé¢
    function continueToMainPage() {
        if (!selectedAvatarId || !selectedAvatarType) {
            showStatusMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ•°å­—äººå½¢è±¡', 'error');
            return;
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('selectedAvatar', selectedAvatarId);
        localStorage.setItem('selectedAvatarType', selectedAvatarType);
        localStorage.setItem('selectedAvatarName', selectedAvatarName);
        localStorage.setItem('selectedAvatarUrl', selectedAvatarUrl);

        // å‘é€è¯·æ±‚åˆ°åç«¯è®¾ç½® SadTalker å›¾ç‰‡
        showStatusMessage('æ­£åœ¨è®¾ç½®æ•°å­—äººå½¢è±¡...', 'loading');

        fetch(`${API_BASE_URL}/set_avatar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ avatar_id: selectedAvatarId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatusMessage('å½¢è±¡è®¾ç½®æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...', 'success');
                setTimeout(() => {
                    window.location.href = '/index';
                }, 1000);
            } else {
                showStatusMessage(`è®¾ç½®å¤±è´¥: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('è®¾ç½®å½¢è±¡å¤±è´¥:', error);
            showStatusMessage('è®¾ç½®å¤±è´¥ï¼Œä½†ä»å¯ç»§ç»­ä½¿ç”¨', 'error');
            setTimeout(() => {
                window.location.href = '/index';
            }, 2000);
        });
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        // åŠ è½½å½¢è±¡
        loadPresetAvatars();
        loadUploadedAvatars();

        // æ£€æŸ¥å·²æœ‰é€‰æ‹©
        checkExistingSelection();

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        browseBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                previewImageFile(e.target.files[0]);
            }
        });

        // ç¡®è®¤ä¸Šä¼ æŒ‰é’®
        confirmUploadBtn.addEventListener('click', () => {
            if (currentFile) {
                uploadImage(currentFile);
            }
        });

        // æ‹–æ‹½ä¸Šä¼ 
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');

            if (e.dataTransfer.files.length > 0) {
                previewImageFile(e.dataTransfer.files[0]);
            }
        });

        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
        dropArea.addEventListener('click', (e) => {
            if (e.target === dropArea || e.target.classList.contains('upload-icon') ||
                e.target.classList.contains('upload-text') || e.target.classList.contains('upload-hint')) {
                fileInput.click();
            }
        });

        // ç»§ç»­æŒ‰é’®
        continueBtn.addEventListener('click', continueToMainPage);

        // å¦‚æœæ²¡æœ‰é€‰æ‹©ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªé¢„ç½®å½¢è±¡
        setTimeout(() => {
            if (!selectedAvatarId) {
                const firstAvatarCard = document.querySelector('.avatar-card[data-id="1"]');
                if (firstAvatarCard) {
                    firstAvatarCard.click();
                }
            }
        }, 500);
    });
</script>
</body>
</html>