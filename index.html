<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å­¦ç”Ÿå¿ƒç†åˆ†ææ•°å­—äººä»£ç† - å¸¦è¡¨æƒ…è¯†åˆ«</title>
    <style>
        /* ========== æ ·å¼ ========== */
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        body{background:linear-gradient(135deg,#a8edea 0%,#fed6e3 100%);color:#333;min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto}
        .header{text-align:center;padding:20px;margin-bottom:30px}
        .header h1{font-size:32px;color:#4a90e2;margin-bottom:10px}
        .header p{font-size:16px;color:#666}
        .main-content{display:flex;gap:20px;margin-bottom:30px}
        .left-panel,.right-panel{flex:1;background:rgba(255,255,255,.9);border-radius:15px;padding:20px;box-shadow:0 8px 25px rgba(0,0,0,.1)}
        .panel-title{font-size:20px;color:#4a90e2;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #eee}
        #scene-container{width:100%;height:300px;background:#f5f5f5;border-radius:10px;overflow:hidden;margin-bottom:15px;position:relative;display:flex;align-items:center;justify-content:center}

        /* æ•°å­—äººå›¾ç‰‡å’Œè§†é¢‘æ ·å¼ */
        #avatar-img{height:100%;max-width:100%;object-fit:contain;transition:opacity 0.5s ease}
        #idle-video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;display:none}
        #avatar-video{width:100%;height:100%;object-fit:contain;display:none}

        /* å¾…æœºæ¨¡å¼æ ·å¼ */
        .idle-mode #avatar-img{opacity:0}
        .idle-mode #idle-video{display:block}

        #video-loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;display:none}
        #video-loading .spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #4a90e2;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px}
        #camera-preview{width:100%;height:250px;background:#333;border-radius:10px;margin-bottom:15px}
        .camera-controls{display:flex;gap:10px;margin-bottom:15px}
        .btn{padding:10px 20px;border:none;border-radius:8px;background:#4a90e2;color:white;font-size:14px;cursor:pointer;transition:all .3s}
        .btn:hover{background:#3a80d2;transform:translateY(-2px)}
        .btn:disabled{background:#ccc;cursor:not-allowed}
        .emotion-display{margin-top:20px;padding:15px;background:#f8f9fa;border-radius:10px}
        .emotion-result{font-size:24px;text-align:center;margin:10px 0}
        .chat-container{margin-bottom:30px}
        .response-bubble{background:white;padding:20px;border-radius:15px;margin-bottom:15px;box-shadow:0 4px 15px rgba(0,0,0,.1);min-height:100px;max-height:300px;overflow-y:auto}
        .input-container{display:flex;gap:10px}
        #user-input{flex:1;padding:15px;border:2px solid #4a90e2;border-radius:10px;font-size:16px;outline:none}
        #submit-btn{padding:15px 30px;background:linear-gradient(135deg,#4a90e2 0%,#357ae8 100%);color:white;border:none;border-radius:10px;font-size:16px;cursor:pointer;transition:all .3s}
        #submit-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(74,144,226,.4)}
        #submit-btn:disabled{background:#ccc;cursor:not-allowed}
        .status-indicator{position:fixed;top:20px;right:20px;background:rgba(46,204,113,.9);color:white;padding:8px 15px;border-radius:20px;font-size:14px;display:flex;align-items:center;gap:8px}
        .status-dot{width:8px;height:8px;background:white;border-radius:50%;animation:pulse 2s infinite}

        /* æ›´æ¢å½¢è±¡æŒ‰é’® */
        .change-avatar-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4a90e2;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .change-avatar-btn:hover {
            background: #3a80d2;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .change-avatar-btn::before {
            content: "ğŸ‘¤";
        }

        /* è¯­éŸ³è¾“å…¥ç›¸å…³æ ·å¼ */
        .voice-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .voice-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .voice-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        .voice-btn.listening {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            animation: pulse 1.5s infinite;
        }

        .voice-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .voice-status {
            font-size: 14px;
            color: #666;
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn::before {
            content: "ğŸ¤";
            font-size: 18px;
        }

        .voice-btn.listening::before {
            content: "ğŸ”´";
        }

        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        @media (max-width:768px){
            .main-content{flex-direction:column}
            .header h1{font-size:24px}
            .change-avatar-btn{bottom:10px;right:10px;padding:8px 15px}
            .voice-input-container{flex-direction:column;}
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ›´æ¢å½¢è±¡æŒ‰é’® -->
        <a href="/select" class="change-avatar-btn">æ›´æ¢å½¢è±¡</a>

        <div class="header">
            <h1 id="page-title">å¤§å­¦ç”Ÿå¿ƒç†åˆ†ææ•°å­—äººä»£ç†</h1>
            <p id="page-subtitle">AIæ•°å­—äººç»“åˆè¡¨æƒ…åˆ†æï¼Œæä¾›æ›´ç²¾å‡†çš„å¿ƒç†çŠ¶æ€è¯„ä¼°</p>
        </div>

        <div class="status-indicator">
            <div class="status-dot"></div>
            <span id="status-text">ç³»ç»Ÿå°±ç»ª</span>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="panel-title">æ•°å­—äººäº¤äº’</div>
                <div id="scene-container">
                    <!-- æ•°å­—äººå›¾ç‰‡ -->
                    <img id="avatar-img" src="" alt="æ•°å­—äºº">
                    <!-- å¾…æœºåŠ¨ç”»è§†é¢‘ -->
                    <video id="idle-video" loop muted playsinline></video>
                    <!-- æ•°å­—äººå›å¤è§†é¢‘ -->
                    <video id="avatar-video" controls></video>
                    <!-- åŠ è½½åŠ¨ç”» -->
                    <div id="video-loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨ç”Ÿæˆæ•°å­—äººè§†é¢‘...</p>
                    </div>
                </div>

                <!-- è¯­éŸ³è¾“å…¥åŒºåŸŸ -->
                <div class="voice-input-container">
                    <button id="voice-btn" class="voice-btn">è¯­éŸ³è¾“å…¥</button>
                    <div id="voice-status" class="voice-status">ç‚¹å‡»æŒ‰é’®å¼€å§‹è¯­éŸ³è¾“å…¥</div>
                </div>

                <div class="input-container">
                    <input type="text" id="user-input" placeholder="è¯·æè¿°ä½ å½“å‰çš„å¿ƒç†çŠ¶æ€æˆ–é‡åˆ°çš„é—®é¢˜...">
                    <button id="submit-btn" class="btn">å‘é€</button>
                </div>
            </div>

            <div class="right-panel">
                <div class="panel-title">è¡¨æƒ…åˆ†æ</div>
                <video id="camera-preview" autoplay playsinline style="display:none;"></video>

                <div class="camera-controls">
                    <button id="camera-toggle" class="btn">å¼€å¯æ‘„åƒå¤´</button>
                    <button id="emotion-toggle" class="btn" disabled>å¼€å¯è¡¨æƒ…åˆ†æ</button>
                </div>

                <div class="emotion-display" style="display:none;">
                    <div class="panel-title">å½“å‰æƒ…ç»ªåˆ†æ</div>
                    <div class="emotion-result" id="emotion-result">ç­‰å¾…åˆ†æ...</div>
                    <div id="emotion-bars"></div>
                </div>
            </div>
        </div>

        <div class="chat-container">
            <div class="panel-title">å¿ƒç†åˆ†æç»“æœ</div>
            <div class="response-bubble" id="response-content">
                åœ¨è¿™é‡Œæ˜¾ç¤ºå¿ƒç†åˆ†æç»“æœ...
            </div>
        </div>
    </div>

    <script>
        /* =============== å…¨å±€å˜é‡ =============== */
        const emotionIcons = {
            'angry': 'ğŸ˜ ', 'disgust': 'ğŸ¤¢', 'fear': 'ğŸ˜¨',
            'happy': 'ğŸ˜Š', 'sad': 'ğŸ˜¢', 'surprise': 'ğŸ˜²',
            'neutral': 'ğŸ˜'
        };
        const emotionDescriptions = {
            'angry': 'ç”Ÿæ°”', 'disgust': 'åŒæ¶', 'fear': 'ææƒ§',
            'happy': 'å¼€å¿ƒ', 'sad': 'æ‚²ä¼¤', 'surprise': 'æƒŠè®¶',
            'neutral': 'å¹³é™'
        };
        const emotionColors = {
            'angry': '#ff6b6b', 'disgust': '#9b59b6', 'fear': '#f39c12',
            'happy': '#2ecc71', 'sad': '#3498db', 'surprise': '#9b59b6',
            'neutral': '#95a5a6'
        };

        // å½¢è±¡åç§°æ˜ å°„
        const avatarNames = {
            '1': 'æ™ºèƒ½åŠ©æ‰‹',
            '2': 'å¿ƒç†å’¨è¯¢å¸ˆ',
            '3': 'å¿ƒçµå¯¼å¸ˆ'
        };

        let isAnalyzing = false;
        let cameraActive = false;
        let emotionAnalysisActive = false;
        let videoStream = null;
        let emotionInterval = null;
        let currentEmotion = 'neutral';
        let currentEmotionScores = {};

        // è¯­éŸ³è¯†åˆ«ç›¸å…³å˜é‡
        let recognition = null;
        let isListening = false;
        let speechTimeout = null;

        // å¾…æœºåŠ¨ç”»ç›¸å…³
        let isIdleMode = false;
        let idleAnimationInterval = null;

        // DOM å…ƒç´ 
        const statusText = document.getElementById('status-text');
        const userInput = document.getElementById('user-input');
        const submitBtn = document.getElementById('submit-btn');
        const responseContent = document.getElementById('response-content');
        const cameraPreview = document.getElementById('camera-preview');
        const cameraToggle = document.getElementById('camera-toggle');
        const emotionToggle = document.getElementById('emotion-toggle');
        const emotionDisplay = document.querySelector('.emotion-display');
        const emotionResult = document.getElementById('emotion-result');
        const emotionBars = document.getElementById('emotion-bars');
        const avatarImg = document.getElementById('avatar-img');
        const idleVideo = document.getElementById('idle-video');
        const avatarVideo = document.getElementById('avatar-video');
        const videoLoading = document.getElementById('video-loading');
        const pageTitle = document.getElementById('page-title');
        const pageSubtitle = document.getElementById('page-subtitle');
        const voiceBtn = document.getElementById('voice-btn');
        const voiceStatus = document.getElementById('voice-status');
        const sceneContainer = document.getElementById('scene-container');

        const API_BASE_URL = 'http://localhost:5000/api';

        /* =============== å¾…æœºåŠ¨ç”»ç®¡ç† =============== */
        async function startIdleAnimation() {
            if (isIdleMode) return;

            try {
                // è·å–å½“å‰é€‰æ‹©çš„æ•°å­—äººID
                const selectedAvatarId = localStorage.getItem('selectedAvatar') || '1';

                // è·å–è¯¥æ•°å­—äººå¯¹åº”çš„å¾…æœºè§†é¢‘
                const response = await fetch(`${API_BASE_URL}/idle_videos?avatar_id=${selectedAvatarId}`);
                const data = await response.json();

                if (data.success && data.videos && data.videos.length > 0) {
                    // è·å–ç¬¬ä¸€ä¸ªè§†é¢‘URL
                    const videoUrl = data.videos[0];

                    // è®¾ç½®è§†é¢‘æº
                    idleVideo.src = videoUrl;
                    idleVideo.loop = true;
                    idleVideo.muted = true;

                    // æ’­æ”¾è§†é¢‘
                    await idleVideo.play();

                    // è¿›å…¥å¾…æœºæ¨¡å¼
                    isIdleMode = true;
                    sceneContainer.classList.add('idle-mode');

                    console.log('å¾…æœºåŠ¨ç”»å·²å¯åŠ¨');
                } else {
                    console.warn('æ²¡æœ‰å¯ç”¨çš„å¾…æœºè§†é¢‘ï¼Œä¿æŒé™æ€å›¾ç‰‡');
                }
            } catch (error) {
                console.error('åŠ è½½å¾…æœºåŠ¨ç”»å¤±è´¥:', error);
                // å¦‚æœè§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œä¿æŒé™æ€å›¾ç‰‡
                isIdleMode = false;
                sceneContainer.classList.remove('idle-mode');
            }
        }

        function stopIdleAnimation() {
            if (!isIdleMode) return;

            // åœæ­¢è§†é¢‘
            if (idleVideo) {
                idleVideo.pause();
                idleVideo.currentTime = 0;
            }

            // é€€å‡ºå¾…æœºæ¨¡å¼
            isIdleMode = false;
            sceneContainer.classList.remove('idle-mode');

            console.log('å¾…æœºåŠ¨ç”»å·²åœæ­¢');
        }

        /* =============== è¯­éŸ³è¾“å…¥åŠŸèƒ½ =============== */
        function initSpeechRecognition() {
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                voiceBtn.disabled = true;
                voiceStatus.textContent = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥';
                console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
                return false;
            }

            // åˆ›å»ºè¯­éŸ³è¯†åˆ«å®ä¾‹
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();

            // é…ç½®è¯†åˆ«å™¨
            recognition.continuous = false;  // ä¸æŒç»­è¯†åˆ«
            recognition.interimResults = true;  // æ˜¾ç¤ºä¸´æ—¶ç»“æœ
            recognition.lang = 'zh-CN';  // è®¾ç½®ä¸ºä¸­æ–‡
            recognition.maxAlternatives = 1;  // åªè¿”å›ä¸€ä¸ªç»“æœ

            // ç»‘å®šäº‹ä»¶
            recognition.onstart = function() {
                isListening = true;
                voiceBtn.classList.add('listening');
                voiceStatus.textContent = 'æ­£åœ¨è†å¬...è¯·å¼€å§‹è¯´è¯';
                statusText.textContent = 'è¯­éŸ³è¯†åˆ«ä¸­...';
                console.log('è¯­éŸ³è¯†åˆ«å¼€å§‹');
                stopIdleAnimation(); // åœæ­¢å¾…æœºåŠ¨ç”»
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';

                // å¤„ç†ç»“æœ
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // æ˜¾ç¤ºä¸´æ—¶ç»“æœ
                if (interimTranscript) {
                    voiceStatus.textContent = `è¯†åˆ«ä¸­: ${interimTranscript}`;
                    userInput.value = interimTranscript;
                }

                // æœ€ç»ˆç»“æœ
                if (finalTranscript) {
                    voiceStatus.textContent = `å·²è¯†åˆ«: ${finalTranscript}`;
                    userInput.value = finalTranscript;

                    // è‡ªåŠ¨æäº¤æˆ–ç­‰å¾…ç”¨æˆ·ç¡®è®¤
                    setTimeout(() => {
                        if (userInput.value.trim()) {
                            voiceStatus.textContent = 'æ­£åœ¨åˆ†æè¯­éŸ³å†…å®¹...';
                            analyzeInput();
                        }
                    }, 1000);
                }
            };

            recognition.onerror = function(event) {
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                isListening = false;
                voiceBtn.classList.remove('listening');

                let errorMessage = 'è¯­éŸ³è¯†åˆ«é”™è¯¯';
                switch(event.error) {
                    case 'no-speech':
                        errorMessage = 'æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³';
                        break;
                    case 'audio-capture':
                        errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£';
                        break;
                    case 'not-allowed':
                        errorMessage = 'éº¦å…‹é£è®¿é—®è¢«æ‹’ç»';
                        break;
                    case 'network':
                        errorMessage = 'ç½‘ç»œé”™è¯¯';
                        break;
                }

                voiceStatus.textContent = errorMessage;
                statusText.textContent = 'ç³»ç»Ÿå°±ç»ª';

                // 5ç§’åé‡ç½®çŠ¶æ€
                setTimeout(() => {
                    voiceStatus.textContent = 'ç‚¹å‡»æŒ‰é’®å¼€å§‹è¯­éŸ³è¾“å…¥';
                }, 5000);
            };

            recognition.onend = function() {
                isListening = false;
                voiceBtn.classList.remove('listening');
                voiceStatus.textContent = 'è¯­éŸ³è¯†åˆ«ç»“æŸ';
                statusText.textContent = 'ç³»ç»Ÿå°±ç»ª';
                console.log('è¯­éŸ³è¯†åˆ«ç»“æŸ');

                // 5ç§’åé‡ç½®çŠ¶æ€
                setTimeout(() => {
                    voiceStatus.textContent = 'ç‚¹å‡»æŒ‰é’®å¼€å§‹è¯­éŸ³è¾“å…¥';
                }, 5000);
            };

            return true;
        }

        function toggleSpeechRecognition() {
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥åŠŸèƒ½');
                    return;
                }
            }

            if (isListening) {
                stopSpeechRecognition();
            } else {
                startSpeechRecognition();
            }
        }

        function startSpeechRecognition() {
            if (isListening) return;

            try {
                recognition.start();
            } catch (error) {
                console.error('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
                voiceStatus.textContent = 'å¯åŠ¨å¤±è´¥ï¼Œè¯·é‡è¯•';
            }
        }

        function stopSpeechRecognition() {
            if (!isListening) return;

            try {
                recognition.stop();
            } catch (error) {
                console.error('åœæ­¢è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
            }
        }

        /* =============== æ•°å­—äººå½¢è±¡ç®¡ç† =============== */
        function loadSelectedAvatar() {
            // ä» localStorage è·å–é€‰æ‹©çš„æ•°å­—äººä¿¡æ¯
            let selectedAvatarId = localStorage.getItem('selectedAvatar');
            let selectedAvatarType = localStorage.getItem('selectedAvatarType');
            let selectedAvatarName = localStorage.getItem('selectedAvatarName');
            let selectedAvatarUrl = localStorage.getItem('selectedAvatarUrl');

            // å¦‚æœæ²¡æœ‰é€‰æ‹©ï¼Œé»˜è®¤ä½¿ç”¨å½¢è±¡1
            if (!selectedAvatarId) {
                selectedAvatarId = '1';
                selectedAvatarType = 'preset';
                selectedAvatarName = 'æ™ºèƒ½åŠ©æ‰‹';
                selectedAvatarUrl = '/avatars/avatar1.png';

                localStorage.setItem('selectedAvatar', selectedAvatarId);
                localStorage.setItem('selectedAvatarType', selectedAvatarType);
                localStorage.setItem('selectedAvatarName', selectedAvatarName);
                localStorage.setItem('selectedAvatarUrl', selectedAvatarUrl);
            }

            // æ›´æ–°å‰ç«¯æ˜¾ç¤ºçš„å›¾ç‰‡
            avatarImg.src = selectedAvatarUrl;

            // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡
            avatarImg.onerror = function() {
                this.src = '/avatars/avatar1.png';
                console.warn('æ•°å­—äººå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡');
            };

            // æ›´æ–°é¡µé¢æ ‡é¢˜æ˜¾ç¤ºå½“å‰å½¢è±¡
            pageTitle.textContent = `å¤§å­¦ç”Ÿå¿ƒç†åˆ†ææ•°å­—äººä»£ç† - ${selectedAvatarName}`;
            pageSubtitle.textContent = `å½“å‰å½¢è±¡: ${selectedAvatarName} | AIæ•°å­—äººç»“åˆè¡¨æƒ…åˆ†æï¼Œæä¾›æ›´ç²¾å‡†çš„å¿ƒç†çŠ¶æ€è¯„ä¼°`;

            console.log(`å·²åŠ è½½æ•°å­—äººå½¢è±¡ ${selectedAvatarId} (${selectedAvatarName})`);

            // ç¡®ä¿åç«¯ä¹Ÿä½¿ç”¨è¿™ä¸ªå½¢è±¡
            setSadTalkerImage(selectedAvatarId);

            // å¯åŠ¨å¾…æœºåŠ¨ç”»
            setTimeout(() => {
                startIdleAnimation();
            }, 500);
        }

        async function setSadTalkerImage(avatarId) {
            try {
                // è°ƒç”¨åç«¯ API æ›´æ–° SadTalker ä½¿ç”¨çš„å›¾ç‰‡
                const response = await fetch(`${API_BASE_URL}/set_avatar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ avatar_id: avatarId })
                });

                const data = await response.json();
                if (data.success) {
                    console.log(`åç«¯å·²è®¾ç½®æ•°å­—äººå½¢è±¡ä¸º: ${avatarId}`);
                } else {
                    console.warn('è®¾ç½®åç«¯æ•°å­—äººå½¢è±¡å¤±è´¥:', data.error);
                }
            } catch (error) {
                console.warn('è®¾ç½®æ•°å­—äººå½¢è±¡è¯·æ±‚å¤±è´¥:', error);
            }
        }

        /* =============== æ˜¾ç¤º/éšè—è¾…åŠ© =============== */
        function showImg() {
            avatarImg.style.display = 'block';
            idleVideo.style.display = 'none';
            avatarVideo.style.display = 'none';
            videoLoading.style.display = 'none';

            // è§†é¢‘ç»“æŸåé‡æ–°å¯åŠ¨å¾…æœºåŠ¨ç”»
            if (!isAnalyzing) {
                setTimeout(() => {
                    startIdleAnimation();
                }, 1000);
            }
        }

        function showVideo() {
            avatarImg.style.display = 'none';
            idleVideo.style.display = 'none';
            avatarVideo.style.display = 'block';
            videoLoading.style.display = 'none';
            stopIdleAnimation(); // æ’­æ”¾è§†é¢‘æ—¶åœæ­¢å¾…æœºåŠ¨ç”»
        }

        /* =============== æ‘„åƒå¤´æ§åˆ¶ =============== */
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' }
                });
                videoStream = stream;
                cameraPreview.srcObject = stream;
                cameraPreview.style.display = 'block';
                cameraToggle.textContent = 'å…³é—­æ‘„åƒå¤´';
                cameraActive = true;
                emotionToggle.disabled = false;
                statusText.textContent = 'æ‘„åƒå¤´å·²å¼€å¯';
            } catch (err) {
                console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´:', err);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™');
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            cameraPreview.srcObject = null;
            cameraPreview.style.display = 'none';
            cameraToggle.textContent = 'å¼€å¯æ‘„åƒå¤´';
            cameraActive = false;
            stopEmotionAnalysis();
            emotionToggle.textContent = 'å¼€å¯è¡¨æƒ…åˆ†æ';
            emotionToggle.disabled = true;
            emotionAnalysisActive = false;
            statusText.textContent = 'ç³»ç»Ÿå°±ç»ª';
        }

        function toggleCamera() {
            if (cameraActive) {
                stopCamera();
            } else {
                startCamera();
            }
        }

        /* =============== è¡¨æƒ…åˆ†ææ§åˆ¶ =============== */
        function startEmotionAnalysis() {
            if (!cameraActive) return;
            emotionAnalysisActive = true;
            emotionToggle.textContent = 'åœæ­¢è¡¨æƒ…åˆ†æ';
            emotionDisplay.style.display = 'block';
            statusText.textContent = 'è¡¨æƒ…åˆ†æä¸­...';
            emotionInterval = setInterval(captureAndAnalyzeEmotion, 2000);
            captureAndAnalyzeEmotion(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        }

        function stopEmotionAnalysis() {
            emotionAnalysisActive = false;
            if (emotionInterval) {
                clearInterval(emotionInterval);
                emotionInterval = null;
            }
            emotionDisplay.style.display = 'none';
            statusText.textContent = 'ç³»ç»Ÿå°±ç»ª';
        }

        function toggleEmotionAnalysis() {
            if (emotionAnalysisActive) {
                stopEmotionAnalysis();
            } else {
                startEmotionAnalysis();
            }
        }

        /* =============== æ•è·è¡¨æƒ… =============== */
        async function captureAndAnalyzeEmotion() {
            if (!cameraActive || !emotionAnalysisActive) return;

            try {
                // åˆ›å»º canvas æ•è·è§†é¢‘å¸§
                const canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 480;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg', 0.7);

                // å‘é€åˆ°åç«¯åˆ†æ
                const res = await fetch(`${API_BASE_URL}/analyze_emotion`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });

                const result = await res.json();
                if (result.success) {
                    currentEmotion = result.dominant_emotion;
                    currentEmotionScores = result.emotion_scores || {};
                    updateEmotionDisplay();
                    statusText.textContent = `æ£€æµ‹åˆ°: ${emotionDescriptions[currentEmotion]}`;
                }
            } catch (e) {
                console.error('è¡¨æƒ…åˆ†æå¤±è´¥:', e);
            }
        }

        function updateEmotionDisplay() {
            // æ›´æ–°æƒ…ç»ªç»“æœæ–‡æœ¬
            emotionResult.textContent = `${emotionIcons[currentEmotion]} ${emotionDescriptions[currentEmotion]}`;

            // æ¸…ç©ºæƒ…ç»ªæ¡
            emotionBars.innerHTML = '';

            // æŒ‰åˆ†æ•°æ’åºæ˜¾ç¤ºæ‰€æœ‰æƒ…ç»ª
            Object.entries(currentEmotionScores)
                .sort((a, b) => b[1] - a[1])
                .forEach(([emotion, score]) => {
                    const barContainer = document.createElement('div');
                    barContainer.style.margin = '5px 0';

                    barContainer.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span>${emotionIcons[emotion] || 'ğŸ˜'} ${emotionDescriptions[emotion] || emotion}</span>
                            <span>${score.toFixed(1)}%</span>
                        </div>
                        <div style="height: 8px; background: #eee; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${score}%; background: ${emotionColors[emotion] || '#4a90e2'}; transition: width 0.5s;"></div>
                        </div>
                    `;

                    emotionBars.appendChild(barContainer);
                });
        }

        /* =============== å¿ƒç†åˆ†æè¯·æ±‚ =============== */
        async function analyzeInput() {
            const text = userInput.value.trim();
            if (!text || isAnalyzing) return;

            // è®¾ç½®çŠ¶æ€
            isAnalyzing = true;
            statusText.textContent = 'åˆ†æä¸­...';
            submitBtn.disabled = true;
            videoLoading.style.display = 'block';
            showImg(); // å…ˆç¡®ä¿æ˜¾ç¤ºå›¾ç‰‡ï¼Œéšè—è§†é¢‘
            stopIdleAnimation(); // åœæ­¢å¾…æœºåŠ¨ç”»

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            responseContent.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åˆ†æä½ çš„å¿ƒç†çŠ¶æ€å¹¶ç”Ÿæˆæ•°å­—äººè§†é¢‘...</p>
                </div>
            `;

            try {
                const payload = {
                    message: text,
                    detected_emotion: currentEmotion,
                    generate_video: true
                };

                const res = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (data.success) {
                    // æ„å»ºå“åº”HTML
                    let html = data.response;

                    // æ·»åŠ æ¨¡å‹æ¥æºå’Œæƒ…ç»ªä¿¡æ¯
                    html += `
                        <div style="margin-top: 20px; padding: 10px; background: rgba(110,203,245,.1); border-radius: 8px; font-size: 14px; color: #3498db">
                            <strong>${data.model_source === 'local_psychology_model' ? 'ğŸ§  æœ¬åœ°å¿ƒç†å¤§æ¨¡å‹' : 'ğŸ¤– æœ¬åœ°AIæ¨¡å‹'} ç”Ÿæˆ</strong> |
                            æƒ…ç»ªçŠ¶æ€: ${emotionDescriptions[currentEmotion]} ${emotionIcons[currentEmotion]}
                        </div>
                    `;

                    responseContent.innerHTML = html;

                    // å¦‚æœæœ‰ç”Ÿæˆçš„è§†é¢‘
                    if (data.video_generated && data.video_url) {
                        avatarVideo.src = data.video_url;
                        showVideo(); // éšè—å›¾ç‰‡ï¼Œæ˜¾ç¤ºè§†é¢‘
                        avatarVideo.play();
                        statusText.textContent = 'åˆ†æå®Œæˆï¼Œè§†é¢‘å·²ç”Ÿæˆ';

                        // è§†é¢‘æ’­æ”¾ç»“æŸåæ¢å¤æ˜¾ç¤ºå›¾ç‰‡
                        avatarVideo.onended = () => {
                            showImg();
                            isAnalyzing = false;
                            setTimeout(() => {
                                startIdleAnimation();
                            }, 500);
                        };
                    } else {
                        showImg();
                        if (data.video_error) {
                            console.warn('è§†é¢‘ç”Ÿæˆå¤±è´¥:', data.video_error);
                        }
                        if (data.tts_error) {
                            console.warn('TTS å¤±è´¥:', data.tts_error);
                        }
                        statusText.textContent = 'åˆ†æå®Œæˆï¼ˆè§†é¢‘ç”Ÿæˆå¤±è´¥ï¼‰';
                        isAnalyzing = false;
                        setTimeout(() => {
                            startIdleAnimation();
                        }, 500);
                    }
                } else {
                    throw new Error(data.error || 'API è¯·æ±‚å¤±è´¥');
                }
            } catch (err) {
                console.error('åˆ†æå¤±è´¥:', err);
                showImg();
                responseContent.innerHTML = `
                    <div style="color: #e74c3c;">
                        <p><strong>åˆ†æå¤±è´¥:</strong> ${err.message}</p>
                        <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</p>
                    </div>
                `;
                statusText.textContent = 'åˆ†æå¤±è´¥';
                isAnalyzing = false;
                setTimeout(() => {
                    startIdleAnimation();
                }, 500);
            } finally {
                // æ¢å¤çŠ¶æ€
                submitBtn.disabled = false;
                userInput.value = '';
                userInput.focus();
            }
        }

        /* =============== åˆå§‹åŒ– =============== */
        document.addEventListener('DOMContentLoaded', () => {
            // 1. é¦–å…ˆåŠ è½½é€‰æ‹©çš„æ•°å­—äººå½¢è±¡
            loadSelectedAvatar();

            // 2. æ£€æŸ¥æ˜¯å¦æœ‰é€‰æ‹©æ•°å­—äººï¼Œå¦‚æœæ²¡æœ‰åˆ™è·³è½¬åˆ°é€‰æ‹©é¡µé¢
            if (!localStorage.getItem('selectedAvatar')) {
                setTimeout(() => {
                    alert('è¯·å…ˆé€‰æ‹©æ•°å­—äººå½¢è±¡');
                    window.location.href = '/select';
                }, 500);
                return;
            }

            // 3. åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
            initSpeechRecognition();

            // 4. ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            submitBtn.addEventListener('click', analyzeInput);
            userInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') analyzeInput();
            });
            cameraToggle.addEventListener('click', toggleCamera);
            emotionToggle.addEventListener('click', toggleEmotionAnalysis);
            voiceBtn.addEventListener('click', toggleSpeechRecognition);

            // 5. ç”¨æˆ·äº¤äº’æ—¶åœæ­¢å¾…æœºåŠ¨ç”»
            userInput.addEventListener('focus', () => {
                stopIdleAnimation();
            });

            userInput.addEventListener('blur', () => {
                if (userInput.value.trim() === '' && !isAnalyzing) {
                    setTimeout(() => {
                        startIdleAnimation();
                    }, 1000);
                }
            });

            // 6. å»¶è¿Ÿè¯¢é—®æ˜¯å¦å¼€å¯æ‘„åƒå¤´
            setTimeout(() => {
                const enableCamera = confirm('æ˜¯å¦å¼€å¯æ‘„åƒå¤´è¿›è¡Œè¡¨æƒ…åˆ†æï¼Ÿ\n\nå¼€å¯æ‘„åƒå¤´å¯ä»¥å®æ—¶åˆ†ææ‚¨çš„é¢éƒ¨è¡¨æƒ…ï¼Œæä¾›æ›´ç²¾å‡†çš„å¿ƒç†åˆ†æã€‚\n\næ³¨æ„ï¼šæ‘„åƒå¤´æ•°æ®ä»…ç”¨äºæœ¬åœ°è¡¨æƒ…åˆ†æï¼Œä¸ä¼šè¢«ä¿å­˜æˆ–ä¸Šä¼ ã€‚');
                if (enableCamera) {
                    startCamera();
                }
            }, 1000);

            // 7. æ˜¾ç¤ºè¯­éŸ³è¾“å…¥è¯´æ˜
            setTimeout(() => {
                if (recognition) {
                    voiceStatus.textContent = 'ç‚¹å‡»"è¯­éŸ³è¾“å…¥"æŒ‰é’®ï¼Œç”¨è¯­éŸ³æè¿°æ‚¨çš„é—®é¢˜';
                }
            }, 1500);
        });
    </script>
</body>
</html>