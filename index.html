<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å­¦ç”Ÿå¿ƒç†åˆ†ææ•°å­—äººä»£ç† - å¸¦è¡¨æƒ…è¯†åˆ«</title>
    <!-- Three.js å·²ä¸éœ€è¦ï¼Œä½†ä¿ç•™ä¹Ÿä¸ä¼šæŠ¥é”™ï¼›ä¸ºäº†â€œæœ€å°æ”¹åŠ¨â€æˆ‘æŠŠå®ƒæ³¨é‡Šæ‰ -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script> -->
    <style>
        /* ========== åŸæ ·å¼å®Œå…¨ä¸å˜ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            padding: 20px;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 32px;
            color: #4a90e2;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 16px;
            color: #666;
        }
        .main-content {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .left-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .right-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .panel-title {
            font-size: 20px;
            color: #4a90e2;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        #scene-container {
            width: 100%;
            height: 300px;
            background: #f5f5f5;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #avatar-img {
            height: 100%;
            max-width: 100%;
            object-fit: contain;
        }
        #avatar-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }
        #video-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: none;
        }
        #video-loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        #camera-preview {
            width: 100%;
            height: 250px;
            background: #333;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .camera-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #4a90e2;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #3a80d2;
            transform: translateY(-2px);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .emotion-display {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .emotion-result {
            font-size: 24px;
            text-align: center;
            margin: 10px 0;
        }
        .chat-container {
            margin-bottom: 30px;
        }
        .response-bubble {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }
        .input-container {
            display: flex;
            gap: 10px;
        }
        #user-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #4a90e2;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
        }
        #submit-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #4a90e2 0%, #357ae8 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
        }
        #submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å¤§å­¦ç”Ÿå¿ƒç†åˆ†ææ•°å­—äººä»£ç† - å¸¦è¡¨æƒ…è¯†åˆ«</h1>
            <p>AIæ•°å­—äººç»“åˆè¡¨æƒ…åˆ†æï¼Œæä¾›æ›´ç²¾å‡†çš„å¿ƒç†çŠ¶æ€è¯„ä¼°</p>
        </div>

        <div class="status-indicator">
            <div class="status-dot"></div>
            <span id="status-text">ç³»ç»Ÿå°±ç»ª</span>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="panel-title">æ•°å­—äººäº¤äº’</div>
                <div id="scene-container">
                    <!-- ä»…æ”¹åŠ¨è¿™é‡Œï¼šç”¨ img æ ‡ç­¾æ›¿æ¢ 3D åœºæ™¯ -->
                    <img id="avatar-img" src="avatar.png" alt="æ•°å­—äºº">
                    <video id="avatar-video" controls></video>
                    <div id="video-loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨ç”Ÿæˆæ•°å­—äººè§†é¢‘...</p>
                    </div>
                </div>

                <div class="input-container">
                    <input type="text" id="user-input" placeholder="è¯·æè¿°ä½ å½“å‰çš„å¿ƒç†çŠ¶æ€æˆ–é‡åˆ°çš„é—®é¢˜...">
                    <button id="submit-btn" class="btn">å‘é€</button>
                </div>
            </div>

            <div class="right-panel">
                <div class="panel-title">è¡¨æƒ…åˆ†æ</div>
                <video id="camera-preview" autoplay playsinline style="display: none;"></video>

                <div class="camera-controls">
                    <button id="camera-toggle" class="btn">å¼€å¯æ‘„åƒå¤´</button>
                    <button id="emotion-toggle" class="btn" disabled>å¼€å¯è¡¨æƒ…åˆ†æ</button>
                </div>

                <div class="emotion-display" style="display: none;">
                    <div class="panel-title">å½“å‰æƒ…ç»ªåˆ†æ</div>
                    <div class="emotion-result" id="emotion-result">ç­‰å¾…åˆ†æ...</div>
                    <div id="emotion-bars"></div>
                </div>
            </div>
        </div>

        <div class="chat-container">
            <div class="panel-title">å¿ƒç†åˆ†æç»“æœ</div>
            <div class="response-bubble" id="response-content">
                åœ¨è¿™é‡Œæ˜¾ç¤ºå¿ƒç†åˆ†æç»“æœ...
            </div>
        </div>
    </div>

    <script>
        /* =============== ä»¥ä¸‹è„šæœ¬ä¸åŸç‰ˆå®Œå…¨ä¸€è‡´ =============== */
        const emotionIcons = {
            angry: 'ğŸ˜ ', disgust: 'ğŸ¤¢', fear: 'ğŸ˜¨',
            happy: 'ğŸ˜Š', sad: 'ğŸ˜¢', surprise: 'ğŸ˜²', neutral: 'ğŸ˜'
        };
        const emotionDescriptions = {
            angry: 'ç”Ÿæ°”', disgust: 'åŒæ¶', fear: 'ææƒ§',
            happy: 'å¼€å¿ƒ', sad: 'æ‚²ä¼¤', surprise: 'æƒŠè®¶', neutral: 'å¹³é™'
        };
        const emotionColors = {
            angry: '#ff6b6b', disgust: '#9b59b6', fear: '#f39c12',
            happy: '#2ecc71', sad: '#3498db', surprise: '#9b59b6', neutral: '#95a5a6'
        };

        let isAnalyzing = false;
        let cameraActive = false;
        let emotionAnalysisActive = false;
        let videoStream = null;
        let emotionInterval = null;
        let currentEmotion = 'neutral';
        let currentEmotionScores = {};

        const statusText = document.getElementById('status-text');
        const userInput = document.getElementById('user-input');
        const submitBtn = document.getElementById('submit-btn');
        const responseContent = document.getElementById('response-content');
        const cameraPreview = document.getElementById('camera-preview');
        const cameraToggle = document.getElementById('camera-toggle');
        const emotionToggle = document.getElementById('emotion-toggle');
        const emotionDisplay = document.querySelector('.emotion-display');
        const emotionResult = document.getElementById('emotion-result');
        const emotionBars = document.getElementById('emotion-bars');
        const avatarVideo = document.getElementById('avatar-video');
        const videoLoading = document.getElementById('video-loading');

        const API_BASE_URL = 'http://localhost:5000/api';

        /* ==================== ä»¥ä¸‹ä¸ºåŸæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ ==================== */
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                if (confirm('æ˜¯å¦å¼€å¯æ‘„åƒå¤´è¿›è¡Œè¡¨æƒ…åˆ†æï¼Ÿ')) startCamera();
            }, 1000);

            submitBtn.addEventListener('click', analyzeInput);
            userInput.addEventListener('keypress', e => { if (e.key === 'Enter') analyzeInput(); });
            cameraToggle.addEventListener('click', toggleCamera);
            emotionToggle.addEventListener('click', toggleEmotionAnalysis);
        });

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                videoStream = stream;
                cameraPreview.srcObject = stream;
                cameraPreview.style.display = 'block';
                cameraToggle.textContent = 'å…³é—­æ‘„åƒå¤´';
                cameraActive = true;
                emotionToggle.disabled = false;
                statusText.textContent = "æ‘„åƒå¤´å·²å¼€å¯";
            } catch (err) {
                console.error("æ‘„åƒå¤´é”™è¯¯:", err);
                alert("æ— æ³•è®¿é—®æ‘„åƒå¤´");
            }
        }
        function stopCamera() {
            if (videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; }
            cameraPreview.srcObject = null;
            cameraPreview.style.display = 'none';
            cameraToggle.textContent = 'å¼€å¯æ‘„åƒå¤´';
            cameraActive = false;
            stopEmotionAnalysis();
            emotionToggle.textContent = 'å¼€å¯è¡¨æƒ…åˆ†æ';
            emotionToggle.disabled = true;
            emotionAnalysisActive = false;
            statusText.textContent = "ç³»ç»Ÿå°±ç»ª";
        }
        function toggleCamera() { cameraActive ? stopCamera() : startCamera(); }

        function startEmotionAnalysis() {
            if (!cameraActive) return;
            emotionAnalysisActive = true;
            emotionToggle.textContent = 'åœæ­¢è¡¨æƒ…åˆ†æ';
            emotionDisplay.style.display = 'block';
            statusText.textContent = "è¡¨æƒ…åˆ†æä¸­...";
            emotionInterval = setInterval(captureAndAnalyzeEmotion, 2000);
            captureAndAnalyzeEmotion();
        }
        function stopEmotionAnalysis() {
            emotionAnalysisActive = false;
            if (emotionInterval) { clearInterval(emotionInterval); emotionInterval = null; }
            emotionDisplay.style.display = 'none';
            statusText.textContent = "ç³»ç»Ÿå°±ç»ª";
        }
        function toggleEmotionAnalysis() { emotionAnalysisActive ? stopEmotionAnalysis() : startEmotionAnalysis(); }

        async function captureAndAnalyzeEmotion() {
            if (!cameraActive || !emotionAnalysisActive) return;
            try {
                const canvas = document.createElement('canvas');
                canvas.width = 640; canvas.height = 480;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg', 0.7);

                const res = await fetch(`${API_BASE_URL}/analyze_emotion`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });
                const result = await res.json();
                if (result.success) {
                    currentEmotion = result.dominant_emotion;
                    currentEmotionScores = result.emotion_scores || {};
                    updateEmotionDisplay();
                    statusText.textContent = `æ£€æµ‹åˆ°: ${emotionDescriptions[currentEmotion]}`;
                }
            } catch (e) { console.error('è¡¨æƒ…åˆ†æå¤±è´¥:', e); }
        }
        function updateEmotionDisplay() {
            emotionResult.textContent = `${emotionIcons[currentEmotion]} ${emotionDescriptions[currentEmotion]}`;
            emotionBars.innerHTML = '';
            Object.entries(currentEmotionScores)
                .sort((a, b) => b[1] - a[1])
                .forEach(([emo, score]) => {
                    const box = document.createElement('div'); box.style.margin = '5px 0';
                    box.innerHTML = `
                    <div style="display:flex;justify-content:space-between"><span>${emotionIcons[emo] || 'ğŸ˜'} ${emotionDescriptions[emo] || emo}</span><span>${score.toFixed(1)}%</span></div>
                    <div style="height:8px;background:#eee;border-radius:4px;overflow:hidden"><div style="height:100%;width:${score}%;background:${emotionColors[emo] || '#4a90e2'};transition:width .5s"></div></div>`;
                    emotionBars.appendChild(box);
                });
        }

        async function analyzeInput() {
            const text = userInput.value.trim();
            if (!text || isAnalyzing) return;
            isAnalyzing = true; statusText.textContent = "åˆ†æä¸­..."; submitBtn.disabled = true;
            videoLoading.style.display = 'block'; avatarVideo.style.display = 'none';
            responseContent.innerHTML = `<div style="text-align:center;padding:20px"><div class="spinner"></div><p>æ­£åœ¨åˆ†æä½ çš„å¿ƒç†çŠ¶æ€å¹¶ç”Ÿæˆæ•°å­—äººè§†é¢‘...</p></div>`;
            try {
                const payload = { message: text, detected_emotion: currentEmotion, generate_video: true };
                const res = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.success) {
                    let html = data.response +
                        `<div style="margin-top:20px;padding:10px;background:rgba(110,203,245,.1);border-radius:8px;font-size:14px;color:#3498db">
                        <strong>${data.model_source === 'local_psychology_model' ? 'ğŸ§  æœ¬åœ°å¿ƒç†å¤§æ¨¡å‹' : 'ğŸ¤– DeepSeek AI'} ç”Ÿæˆ</strong> | æƒ…ç»ªçŠ¶æ€: ${emotionDescriptions[currentEmotion]} ${emotionIcons[currentEmotion]}
                    </div>`;
                    responseContent.innerHTML = html;

                    if (data.video_generated && data.video_url) {
                        avatarVideo.src = data.video_url;
                        avatarVideo.style.display = 'block';
                        videoLoading.style.display = 'none';
                        avatarVideo.play();
                        statusText.textContent = "åˆ†æå®Œæˆï¼Œè§†é¢‘å·²ç”Ÿæˆ";
                    } else {
                        videoLoading.style.display = 'none';
                        if (data.video_error) console.warn('è§†é¢‘ç”Ÿæˆå¤±è´¥:', data.video_error);
                        if (data.tts_error) console.warn('TTS å¤±è´¥:', data.tts_error);
                        statusText.textContent = "åˆ†æå®Œæˆï¼ˆè§†é¢‘ç”Ÿæˆå¤±è´¥ï¼‰";
                    }
                } else throw new Error(data.error || 'API è¯·æ±‚å¤±è´¥');
            } catch (err) {
                console.error(err);
                videoLoading.style.display = 'none';
                responseContent.innerHTML = `<div style="color:#e74c3c"><p>åˆ†æå¤±è´¥: ${err.message}</p><p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</p></div>`;
                statusText.textContent = "åˆ†æå¤±è´¥";
            } finally {
                isAnalyzing = false; submitBtn.disabled = false; userInput.value = ''; userInput.focus();
            }
        }
    </script>
</body>
</html>