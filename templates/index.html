<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å­¦ç”Ÿå¿ƒç†åˆ†ææ•°å­—äººä»£ç† - å¸¦è¡¨æƒ…è¯†åˆ«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            overflow: hidden;
            height: 100vh;
            padding: 20px;
        }
        
        :root {
            --doubao-primary: #6ecbf5;
            --doubao-secondary: #4a90e2;
            --doubao-light: rgba(232, 244, 252, 0.7);
            --doubao-accent: #ff8c94;
            --text-primary: #333333;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            text-align: center;
            z-index: 100;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 24px;
            color: var(--doubao-secondary);
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .header p {
            font-size: 14px;
            color: var(--doubao-primary);
        }
        
        /* 3Dåœºæ™¯å®¹å™¨ - è°ƒæ•´ä½ç½®åˆ°å·¦ä¾§ */
        #scene-container {
            position: absolute;
            top: 80px;
            left: 20px;
            width: 320px;
            height: 320px;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(110, 203, 245, 0.3);
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 50;
        }
        
        /* æ‘„åƒå¤´é¢„è§ˆå®¹å™¨ - æ”¾åœ¨å³ä¾§ */
        #camera-container {
            position: absolute;
            top: 80px;
            right: 20px;
            width: 320px;
            height: 240px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: none; /* é»˜è®¤éšè—ï¼Œç”¨æˆ·åŒæ„åæ˜¾ç¤º */
        }
        
        #camera-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 101;
        }
        
        .camera-btn {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .camera-btn:hover {
            background: white;
            transform: translateY(-2px);
        }
        
        .camera-btn.active {
            background: var(--doubao-primary);
            color: white;
        }
        
        /* è¡¨æƒ…ç»“æœæ˜¾ç¤ºåŒºåŸŸ */
        .emotion-display {
            position: absolute;
            top: 410px;
            right: 20px;
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 100;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: none; /* é»˜è®¤éšè— */
        }
        
        .emotion-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .emotion-icon {
            font-size: 24px;
        }
        
        .emotion-title {
            font-size: 18px;
            color: var(--doubao-secondary);
            font-weight: 600;
        }
        
        .emotion-result {
            font-size: 32px;
            text-align: center;
            margin: 15px 0;
            min-height: 40px;
        }
        
        .emotion-bar-container {
            margin-top: 15px;
        }
        
        .emotion-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .emotion-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #6ecbf5, #4a90e2);
            width: 0%;
            transition: width 1s ease;
        }
        
        .emotion-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-top: 2px;
        }
        
        .chat-container {
            position: absolute;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(85% - 360px); /* å‡å»ä¸¤ä¾§å®¹å™¨çš„å®½åº¦ */
            max-width: 800px;
            z-index: 100;
        }
        
        .response-bubble {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            max-height: 200px;
            overflow-y: auto;
        }
        
        .response-content {
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        #input-container {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(85% - 360px); /* å‡å»ä¸¤ä¾§å®¹å™¨çš„å®½åº¦ */
            max-width: 800px;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 100;
            display: flex;
            gap: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        #user-input {
            flex: 1;
            padding: 15px 20px;
            border-radius: 15px;
            border: 2px solid var(--doubao-primary);
            background: rgba(255, 255, 255, 0.7);
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
            outline: none;
        }
        
        #user-input:focus {
            border-color: var(--doubao-secondary);
            box-shadow: 0 0 0 3px rgba(110, 203, 245, 0.2);
            background: white;
        }
        
        #user-input::placeholder {
            color: #95a5a6;
        }
        
        #submit-btn {
            padding: 15px 30px;
            border-radius: 15px;
            border: none;
            background: linear-gradient(135deg, var(--doubao-primary) 0%, var(--doubao-secondary) 100%);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            box-shadow: 0 4px 15px rgba(110, 203, 245, 0.4);
        }
        
        #submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(110, 203, 245, 0.6);
        }
        
        #submit-btn:active {
            transform: translateY(0);
        }
        
        #submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(110, 203, 245, 0.3);
            border-radius: 50%;
            border-top-color: var(--doubao-primary);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            background: rgba(46, 204, 113, 0.9);
            color: white;
            font-size: 14px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            animation: pulse 2s infinite;
        }
        
        .status-dot.analyzing {
            background: var(--doubao-accent);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }
        
        .watermark {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            z-index: 50;
            text-align: center;
        }
        
        /* éšè—åˆ†æä¿¡æ¯ */
        .analysis-info {
            display: none;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            #scene-container,
            #camera-container,
            .emotion-display {
                width: 280px;
            }
            
            #scene-container {
                height: 280px;
            }
            
            .chat-container,
            #input-container {
                width: calc(100% - 40px);
                left: 20px;
                transform: none;
            }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 20px;
            }
            
            .header p {
                font-size: 12px;
            }
            
            #scene-container,
            #camera-container {
                width: 200px;
                height: 200px;
                top: 60px;
            }
            
            .emotion-display {
                width: 200px;
                top: 270px;
            }
            
            .chat-container {
                width: calc(100% - 40px);
                bottom: 160px;
            }
            
            #input-container {
                width: calc(100% - 40px);
                bottom: 30px;
                padding: 15px;
                left: 20px;
                transform: none;
            }
            
            .response-bubble {
                padding: 15px;
                max-height: 150px;
            }
            
            #user-input {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            #submit-btn {
                padding: 12px 20px;
                min-width: 100px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>å¤§å­¦ç”Ÿå¿ƒç†åˆ†ææ•°å­—äººä»£ç† - å¸¦è¡¨æƒ…è¯†åˆ«</h1>
        <p>AIæ•°å­—äººç»“åˆè¡¨æƒ…åˆ†æï¼Œæä¾›æ›´ç²¾å‡†çš„å¿ƒç†çŠ¶æ€è¯„ä¼°</p>
    </div>
    
    <div class="status-indicator">
        <div class="status-dot"></div>
        <span id="status-text">ç³»ç»Ÿå°±ç»ª</span>
    </div>
    
    <!-- 3Dæ•°å­—äººåœºæ™¯ -->
    <div id="scene-container"></div>
    
    <!-- æ‘„åƒå¤´é¢„è§ˆ -->
    <div id="camera-container">
        <video id="camera-preview" autoplay playsinline></video>
        <div class="camera-controls">
            <button id="camera-toggle" class="camera-btn">å¼€å¯æ‘„åƒå¤´</button>
            <button id="emotion-toggle" class="camera-btn" disabled>å¼€å¯è¡¨æƒ…åˆ†æ</button>
        </div>
    </div>
    
    <!-- è¡¨æƒ…ç»“æœæ˜¾ç¤º -->
    <div class="emotion-display">
        <div class="emotion-header">
            <div class="emotion-icon" id="emotion-icon">ğŸ˜</div>
            <div class="emotion-title">å½“å‰æƒ…ç»ªåˆ†æ</div>
        </div>
        <div class="emotion-result" id="emotion-result">ç­‰å¾…åˆ†æ...</div>
        <div class="emotion-bar-container" id="emotion-bars">
            <!-- åŠ¨æ€ç”Ÿæˆæƒ…ç»ªæ¡ -->
        </div>
    </div>
    
    <!-- å¯¹è¯åŒºåŸŸ -->
    <div class="chat-container">
        <div id="response-container" style="display: none;">
            <div class="response-bubble">
                <div class="response-content" id="response-content"></div>
            </div>
        </div>
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div id="input-container">
        <input type="text" id="user-input" placeholder="è¯·æè¿°ä½ å½“å‰çš„å¿ƒç†çŠ¶æ€æˆ–é‡åˆ°çš„é—®é¢˜...">
        <button id="submit-btn">å‘é€</button>
    </div>
    
    <div class="watermark">å¤§å­¦ç”Ÿå¿ƒç†å¥åº·æ”¯æŒç³»ç»Ÿ â€¢ ä¸“ä¸šå¿ƒç†åˆ†æä¸è¡¨æƒ…è¯†åˆ«</div>

    <script>
        // APIé…ç½®
        const API_BASE_URL = 'http://localhost:5000/api';

        // çŠ¶æ€å˜é‡
        let isAnalyzing = false;
        let cameraActive = false;
        let emotionAnalysisActive = false;
        let videoStream = null;
        let emotionInterval = null;
        let currentEmotion = 'neutral';
        let currentEmotionScores = {};
        
        // DOMå…ƒç´ 
        const statusText = document.getElementById('status-text');
        const statusDot = document.querySelector('.status-dot');
        const responseContainer = document.getElementById('response-container');
        const responseContent = document.getElementById('response-content');
        const submitBtn = document.getElementById('submit-btn');
        const userInput = document.getElementById('user-input');
        const cameraContainer = document.getElementById('camera-container');
        const cameraPreview = document.getElementById('camera-preview');
        const cameraToggle = document.getElementById('camera-toggle');
        const emotionToggle = document.getElementById('emotion-toggle');
        const emotionDisplay = document.querySelector('.emotion-display');
        const emotionResult = document.getElementById('emotion-result');
        const emotionIcon = document.getElementById('emotion-icon');
        const emotionBars = document.getElementById('emotion-bars');
        
        // æƒ…ç»ªå›¾æ ‡æ˜ å°„
        const emotionIcons = {
            'angry': 'ğŸ˜ ',
            'disgust': 'ğŸ¤¢',
            'fear': 'ğŸ˜¨',
            'happy': 'ğŸ˜Š',
            'sad': 'ğŸ˜¢',
            'surprise': 'ğŸ˜²',
            'neutral': 'ğŸ˜'
        };
        
        // æƒ…ç»ªé¢œè‰²æ˜ å°„
        const emotionColors = {
            'angry': '#ff6b6b',
            'disgust': '#9b59b6',
            'fear': '#f39c12',
            'happy': '#2ecc71',
            'sad': '#3498db',
            'surprise': '#9b59b6',
            'neutral': '#95a5a6'
        };
        
        // æƒ…ç»ªä¸­æ–‡æè¿°
        const emotionDescriptions = {
            'angry': 'ç”Ÿæ°”',
            'disgust': 'åŒæ¶',
            'fear': 'ææƒ§',
            'happy': 'å¼€å¿ƒ',
            'sad': 'æ‚²ä¼¤',
            'surprise': 'æƒŠè®¶',
            'neutral': 'å¹³é™'
        };

        // ==================== 3Dæ•°å­—äººéƒ¨åˆ† ====================
        
        // åˆ›å»ºä¼˜åŒ–åçš„é›ªäººå½¢è±¡
        function createSnowmanCharacter() {
            const container = document.getElementById('scene-container');
            
            // åˆ›å»ºåœºæ™¯
            const scene = new THREE.Scene();
            scene.background = null;
            
            // åˆ›å»ºç›¸æœº
            const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 5);
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            const renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            
            // æ·»åŠ ç¯å…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
            mainLight.position.set(5, 10, 5);
            mainLight.castShadow = true;
            scene.add(mainLight);
            
            const fillLight = new THREE.DirectionalLight(0xb3e0ff, 0.4);
            fillLight.position.set(-5, 5, 5);
            scene.add(fillLight);
            
            // åˆ›å»ºé›ªäººç»„
            const snowman = new THREE.Group();
            
            // åˆ›å»ºé›ªäººèº«ä½“
            const bottomBodyGeometry = new THREE.SphereGeometry(1.0, 32, 32);
            const headGeometry = new THREE.SphereGeometry(0.7, 32, 32);
            
            const snowMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xf8f8f8,
                shininess: 30,
                transparent: true,
                opacity: 0.95
            });
            
            const bottomBody = new THREE.Mesh(bottomBodyGeometry, snowMaterial);
            bottomBody.position.y = -0.3;
            bottomBody.castShadow = true;
            snowman.add(bottomBody);
            
            const head = new THREE.Mesh(headGeometry, snowMaterial);
            head.position.y = 0.9;
            head.castShadow = true;
            head.scale.set(1, 1.1, 1);
            snowman.add(head);
            
            // åˆ›å»ºçœ¼ç›
            const eyeGroup = new THREE.Group();
            
            const eyeWhiteGeometry = new THREE.SphereGeometry(0.18, 16, 16);
            const eyeWhiteMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
            
            const leftEyeWhite = new THREE.Mesh(eyeWhiteGeometry, eyeWhiteMaterial);
            leftEyeWhite.position.set(-0.25, 1.0, 0.55);
            eyeGroup.add(leftEyeWhite);
            
            const rightEyeWhite = new THREE.Mesh(eyeWhiteGeometry, eyeWhiteMaterial);
            rightEyeWhite.position.set(0.25, 1.0, 0.55);
            eyeGroup.add(rightEyeWhite);
            
            const pupilGeometry = new THREE.SphereGeometry(0.1, 12, 12);
            const pupilMaterial = new THREE.MeshPhongMaterial({ color: 0x2c3e50 });
            
            const leftPupil = new THREE.Mesh(pupilGeometry, pupilMaterial);
            leftPupil.position.set(-0.25, 1.0, 0.7);
            eyeGroup.add(leftPupil);
            
            const rightPupil = new THREE.Mesh(pupilGeometry, pupilMaterial);
            rightPupil.position.set(0.25, 1.0, 0.7);
            eyeGroup.add(rightPupil);
            
            snowman.add(eyeGroup);
            
            // é¼»å­
            const noseGeometry = new THREE.SphereGeometry(0.05, 12, 12);
            const noseMaterial = new THREE.MeshPhongMaterial({ color: 0xffa8b5 });
            const nose = new THREE.Mesh(noseGeometry, noseMaterial);
            nose.position.set(0, 0.95, 0.6);
            snowman.add(nose);
            
            // å˜´å·´
            const mouthGeometry = new THREE.TorusGeometry(0.15, 0.02, 8, 32, Math.PI);
            const mouthMaterial = new THREE.MeshPhongMaterial({ color: 0xff6b7a });
            const mouth = new THREE.Mesh(mouthGeometry, mouthMaterial);
            mouth.position.set(0, 0.8, 0.6);
            mouth.rotation.x = Math.PI / 2;
            snowman.add(mouth);
            
            // è…®çº¢
            const blushGeometry = new THREE.SphereGeometry(0.12, 12, 12);
            const blushMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xff9eb5,
                transparent: true,
                opacity: 0.7
            });
            
            const leftBlush = new THREE.Mesh(blushGeometry, blushMaterial);
            leftBlush.position.set(-0.45, 0.95, 0.5);
            snowman.add(leftBlush);
            
            const rightBlush = new THREE.Mesh(blushGeometry, blushMaterial);
            rightBlush.position.set(0.45, 0.95, 0.5);
            snowman.add(rightBlush);
            
            snowman.position.set(0, 0, 0);
            scene.add(snowman);
            
            // æ·»åŠ åŠ¨ç”»
            let animationTime = 0;
            let blinkTimer = 0;
            let isBlinking = false;
            
            function animate() {
                requestAnimationFrame(animate);
                
                animationTime += 0.015;
                blinkTimer += 0.05;
                
                // å‘¼å¸æ•ˆæœ
                const breath = Math.sin(animationTime * 1.5) * 0.02 + 1;
                snowman.scale.set(breath, breath, breath);
                
                // æµ®åŠ¨æ•ˆæœ
                snowman.position.y = Math.sin(animationTime) * 0.1;
                
                // åŸºç¡€æ—‹è½¬
                snowman.rotation.y = animationTime * 0.05;
                
                // éšæœºçœ¨çœ¼
                if (!isBlinking && blinkTimer > 10 + Math.random() * 20) {
                    isBlinking = true;
                    blinkTimer = 0;
                }
                
                if (isBlinking) {
                    const blinkProgress = Math.min(blinkTimer * 10, 1);
                    const eyeScaleY = 1 - blinkProgress;
                    leftEyeWhite.scale.y = eyeScaleY;
                    rightEyeWhite.scale.y = eyeScaleY;
                    
                    if (blinkTimer > 0.2) {
                        isBlinking = false;
                        blinkTimer = 0;
                    }
                } else {
                    leftEyeWhite.scale.y = 1;
                    rightEyeWhite.scale.y = 1;
                }
                
                // æ ¹æ®å½“å‰æƒ…ç»ªè°ƒæ•´é›ªäººè¡¨æƒ…
                updateSnowmanByEmotion(snowman, currentEmotion);
                
                renderer.render(scene, camera);
            }
            
            animate();
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
            
            return { snowman };
        }
        
        // æ ¹æ®æƒ…ç»ªæ›´æ–°é›ªäººè¡¨æƒ…
        function updateSnowmanByEmotion(snowman, emotion) {
            if (!snowman.children || !snowman.children[1]) return;
            
            const head = snowman.children[1]; // å¤´éƒ¨
            
            switch(emotion) {
                case 'happy':
                    // å¾®ç¬‘
                    if (head.children && head.children[4]) {
                        head.children[4].position.y = 0.8; // å˜´å·´ä½ç½®
                        head.children[4].rotation.x = Math.PI / 2 - 0.1;
                    }
                    break;
                case 'sad':
                    // éš¾è¿‡
                    if (head.children && head.children[4]) {
                        head.children[4].position.y = 0.85;
                        head.children[4].rotation.x = Math.PI / 2 + 0.1;
                    }
                    break;
                case 'angry':
                    // ç”Ÿæ°”
                    break;
                default:
                    // ä¸­æ€§
                    if (head.children && head.children[4]) {
                        head.children[4].position.y = 0.8;
                        head.children[4].rotation.x = Math.PI / 2;
                    }
            }
        }

        // ==================== æ‘„åƒå¤´æ§åˆ¶éƒ¨åˆ† ====================
        
        // å¼€å¯æ‘„åƒå¤´
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: "user" // å‰ç½®æ‘„åƒå¤´
                    }
                });
                
                videoStream = stream;
                cameraPreview.srcObject = stream;
                cameraContainer.style.display = 'block';
                cameraToggle.textContent = 'å…³é—­æ‘„åƒå¤´';
                cameraToggle.classList.add('active');
                cameraActive = true;
                
                // å¯ç”¨è¡¨æƒ…åˆ†ææŒ‰é’®
                emotionToggle.disabled = false;
                statusText.textContent = "æ‘„åƒå¤´å·²å¼€å¯";
                
                console.log("æ‘„åƒå¤´å·²å¼€å¯");
            } catch (err) {
                console.error("æ— æ³•è®¿é—®æ‘„åƒå¤´: ", err);
                alert("éœ€è¦æ‘„åƒå¤´æƒé™ä»¥å®ç°è¡¨æƒ…åˆ†æåŠŸèƒ½ã€‚");
            }
        }
        
        // å…³é—­æ‘„åƒå¤´
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            cameraPreview.srcObject = null;
            cameraContainer.style.display = 'none';
            cameraToggle.textContent = 'å¼€å¯æ‘„åƒå¤´';
            cameraToggle.classList.remove('active');
            cameraActive = false;
            
            // å…³é—­è¡¨æƒ…åˆ†æ
            stopEmotionAnalysis();
            emotionToggle.textContent = 'å¼€å¯è¡¨æƒ…åˆ†æ';
            emotionToggle.disabled = true;
            emotionToggle.classList.remove('active');
            emotionAnalysisActive = false;
            
            statusText.textContent = "ç³»ç»Ÿå°±ç»ª";
        }
        
        // å¼€å¯è¡¨æƒ…åˆ†æ
        function startEmotionAnalysis() {
            if (!cameraActive) return;
            
            emotionAnalysisActive = true;
            emotionToggle.textContent = 'åœæ­¢è¡¨æƒ…åˆ†æ';
            emotionToggle.classList.add('active');
            emotionDisplay.style.display = 'block';
            statusText.textContent = "è¡¨æƒ…åˆ†æä¸­...";
            
            // å¼€å§‹å®šæœŸåˆ†æè¡¨æƒ…ï¼ˆæ¯2ç§’ä¸€æ¬¡ï¼‰
            emotionInterval = setInterval(captureAndAnalyzeEmotion, 2000);
            
            // åˆå§‹åˆ†æ
            setTimeout(captureAndAnalyzeEmotion, 500);
        }
        
        // åœæ­¢è¡¨æƒ…åˆ†æ
        function stopEmotionAnalysis() {
            emotionAnalysisActive = false;
            if (emotionInterval) {
                clearInterval(emotionInterval);
                emotionInterval = null;
            }
            emotionDisplay.style.display = 'none';
            statusText.textContent = "ç³»ç»Ÿå°±ç»ª";
        }
        
        // æ•è·å¹¶åˆ†æè¡¨æƒ…
        async function captureAndAnalyzeEmotion() {
            if (!cameraActive || !emotionAnalysisActive) return;
            
            try {
                // ä»è§†é¢‘æµä¸­æ•è·ä¸€å¸§
                const canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 480;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
                
                // å°†å›¾ç‰‡è½¬æ¢ä¸ºBase64
                const imageData = canvas.toDataURL('image/jpeg', 0.7);
                
                // è°ƒç”¨åç«¯APIåˆ†æè¡¨æƒ…
                const response = await fetch(`${API_BASE_URL}/analyze_emotion`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentEmotion = result.dominant_emotion;
                    currentEmotionScores = result.emotion_scores;
                    
                    // æ›´æ–°UIæ˜¾ç¤º
                    updateEmotionDisplay();
                    
                    // æ›´æ–°çŠ¶æ€æç¤º
                    statusText.textContent = `æ£€æµ‹åˆ°: ${emotionDescriptions[currentEmotion] || currentEmotion}`;
                }
            } catch (error) {
                console.error('è¡¨æƒ…åˆ†æAPIè°ƒç”¨å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°è¡¨æƒ…æ˜¾ç¤ºUI
        function updateEmotionDisplay() {
            // æ›´æ–°æƒ…ç»ªç»“æœ
            emotionResult.textContent = emotionIcons[currentEmotion] + ' ' + 
                                      (emotionDescriptions[currentEmotion] || currentEmotion);
            emotionIcon.textContent = emotionIcons[currentEmotion];
            
            // æ›´æ–°æƒ…ç»ªæ¡
            updateEmotionBars();
        }
        
        // æ›´æ–°æƒ…ç»ªæ¡
        function updateEmotionBars() {
            emotionBars.innerHTML = '';
            
            // æ’åºæƒ…ç»ªåˆ†æ•°
            const sortedEmotions = Object.entries(currentEmotionScores || {})
                .sort((a, b) => b[1] - a[1]);
            
            sortedEmotions.forEach(([emotion, score]) => {
                const barContainer = document.createElement('div');
                barContainer.className = 'emotion-bar-container';
                
                const emotionLabel = document.createElement('div');
                emotionLabel.className = 'emotion-label';
                emotionLabel.innerHTML = `
                    <span>${emotionIcons[emotion] || 'ğŸ˜'} ${emotionDescriptions[emotion] || emotion}</span>
                    <span>${score.toFixed(1)}%</span>
                `;
                
                const bar = document.createElement('div');
                bar.className = 'emotion-bar';
                
                const fill = document.createElement('div');
                fill.className = 'emotion-fill';
                fill.style.width = `${score}%`;
                fill.style.background = emotionColors[emotion] || '#6ecbf5';
                
                bar.appendChild(fill);
                barContainer.appendChild(emotionLabel);
                barContainer.appendChild(bar);
                
                emotionBars.appendChild(barContainer);
            });
        }

        // ==================== ä¸»è¦äº¤äº’åŠŸèƒ½ ====================
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            // åˆ›å»º3Dé›ªäºº
            const { snowman } = createSnowmanCharacter();
            
            // è¯¢é—®æ˜¯å¦å¼€å¯æ‘„åƒå¤´
            setTimeout(() => {
                if (confirm('æ˜¯å¦å¼€å¯æ‘„åƒå¤´è¿›è¡Œå®æ—¶è¡¨æƒ…åˆ†æä»¥ä¼˜åŒ–å¿ƒç†è¯„ä¼°ï¼Ÿ\n\nå¼€å¯åï¼Œç³»ç»Ÿå°†åˆ†ææ‚¨çš„é¢éƒ¨è¡¨æƒ…ï¼Œæä¾›æ›´ç²¾å‡†çš„å¿ƒç†çŠ¶æ€è¯„ä¼°ã€‚')) {
                    startCamera();
                    setTimeout(() => {
                        if (cameraActive && confirm('æ˜¯å¦åŒæ—¶å¼€å¯å®æ—¶è¡¨æƒ…åˆ†æï¼Ÿ')) {
                            startEmotionAnalysis();
                        }
                    }, 1000);
                }
            }, 1000);
        });
        
        // é¡µé¢å…³é—­æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
        
        // æ‘„åƒå¤´åˆ‡æ¢æŒ‰é’®
        cameraToggle.addEventListener('click', () => {
            if (cameraActive) {
                stopCamera();
            } else {
                startCamera();
            }
        });
        
        // è¡¨æƒ…åˆ†æåˆ‡æ¢æŒ‰é’®
        emotionToggle.addEventListener('click', () => {
            if (emotionAnalysisActive) {
                stopEmotionAnalysis();
            } else {
                startEmotionAnalysis();
            }
        });
        
        // å¤„ç†ç”¨æˆ·è¾“å…¥
        submitBtn.addEventListener('click', analyzeInput);
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeInput();
            }
        });

        async function analyzeInput() {
            const inputText = userInput.value.trim();
            if (inputText && !isAnalyzing) {
                isAnalyzing = true;
                statusText.textContent = "å¿ƒç†åˆ†æä¸­...";
                statusDot.classList.add('analyzing');
                submitBtn.disabled = true;
                
                // æ˜¾ç¤ºå“åº”å®¹å™¨
                responseContainer.style.display = 'block';
                responseContent.innerHTML = `<span class="loading"></span>æ­£åœ¨åˆ†æä½ çš„å¿ƒç†çŠ¶æ€ï¼Œè¯·ç¨å€™...`;
                
                try {
                    // æ„å»ºè¯·æ±‚æ•°æ®ï¼ŒåŒ…å«å½“å‰æƒ…ç»ª
                    const payload = {
                        message: inputText,
                        detected_emotion: currentEmotion
                    };
                    
                    // è°ƒç”¨Pythonåç«¯API
                    const response = await fetch(`${API_BASE_URL}/analyze`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        // æ ¼å¼åŒ–å“åº”å†…å®¹
                        let formattedResponse = data.response;
                        
                        // æ·»åŠ æƒ…ç»ªä¸Šä¸‹æ–‡æç¤º
                        if (currentEmotion !== 'neutral') {
                            const emotionNote = `<div style="margin-top: 10px; padding: 10px; background: rgba(110, 203, 245, 0.1); border-radius: 8px; font-size: 14px;">
                                <strong>ğŸ¤– AIæç¤ºï¼š</strong>åœ¨åˆ†ææ‚¨çš„æè¿°æ—¶ï¼Œç³»ç»Ÿæ£€æµ‹åˆ°æ‚¨å½“å‰çš„<strong>${emotionDescriptions[currentEmotion] || currentEmotion}${emotionIcons[currentEmotion]}</strong>æƒ…ç»ªï¼Œè¿™å¯èƒ½å½±å“æ‚¨çš„æ„Ÿå—å’Œæƒ³æ³•ã€‚
                            </div>`;
                            formattedResponse += emotionNote;
                        }
                        
                        responseContent.innerHTML = formattedResponse;
                        statusText.textContent = "åˆ†æå®Œæˆ";
                    } else {
                        responseContent.innerHTML = `æŠ±æ­‰ï¼Œåˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ã€‚è¯·ç¨åå†è¯•ã€‚<br><small>é”™è¯¯ä¿¡æ¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}</small>`;
                        statusText.textContent = "åˆ†æå¤±è´¥";
                    }
                    
                } catch (error) {
                    console.error('APIè°ƒç”¨é”™è¯¯:', error);
                    responseContent.innerHTML = `ç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚<br><small>é”™è¯¯è¯¦æƒ…: ${error.message}</small>`;
                    statusText.textContent = "ç½‘ç»œé”™è¯¯";
                } finally {
                    isAnalyzing = false;
                    statusDot.classList.remove('analyzing');
                    submitBtn.disabled = false;
                    userInput.value = '';
                    userInput.focus();
                    
                    // 3ç§’åæ¢å¤å°±ç»ªçŠ¶æ€
                    setTimeout(() => {
                        if (!isAnalyzing) {
                            statusText.textContent = emotionAnalysisActive ? 
                                `æ£€æµ‹åˆ°: ${emotionDescriptions[currentEmotion] || currentEmotion}` : 
                                "ç³»ç»Ÿå°±ç»ª";
                        }
                    }, 3000);
                }
            }
        }
    </script>
</body>
</html>